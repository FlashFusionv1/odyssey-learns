# Developer Onboarding Guide

Welcome to Inner Odyssey! This guide will get you from zero to productive in under 1 hour.

---

## Prerequisites

**Required:**
- Node.js 18+ (recommend using [nvm](https://github.com/nvm-sh/nvm))
- Git
- Modern browser (Chrome, Firefox, Safari, Edge)

**Recommended:**
- VS Code with extensions:
  - ESLint
  - Prettier
  - Tailwind CSS IntelliSense
  - TypeScript and JavaScript Language Features

---

## Initial Setup (15 minutes)

### 1. Clone Repository

```bash
git clone [REPO_URL]
cd inner-odyssey
```

### 2. Install Dependencies

```bash
npm install
```

This installs:
- React 18.3 + TypeScript
- Tailwind CSS + shadcn/ui
- React Query (TanStack Query)
- Supabase client
- ~50 other dependencies

### 3. Environment Variables

**âš ï¸ CRITICAL: The `.env` file is auto-generated by Lovable Cloud. DO NOT EDIT MANUALLY.**

The file contains:
```
VITE_SUPABASE_URL=https://hcsglifjqdmiykrrmncn.supabase.co
VITE_SUPABASE_PUBLISHABLE_KEY=eyJhbGc...
VITE_SUPABASE_PROJECT_ID=hcsglifjqdmiykrrmncn
```

These are automatically configured and updated by Lovable Cloud.

### 4. Start Development Server

```bash
npm run dev
```

Visit: **http://localhost:5173**

You should see the Inner Odyssey landing page.

### 5. Create Test Accounts

**Parent Account:**
1. Click "Sign Up" button
2. Enter email, password, full name
3. Complete reCAPTCHA
4. Account created (auto-confirmed in dev)

**Add Test Child:**
1. After signup, you're redirected to `/parent-setup`
2. Add child name, grade level
3. Click "Create Child"
4. Child profile created

**Admin Account (Optional):**
1. Visit `/admin-setup`
2. Enter your email
3. System checks if email is whitelisted (requires manual DB update)
4. If whitelisted, admin role assigned

---

## Project Structure Tour

```
inner-odyssey/
â”œâ”€â”€ docs/                      # Documentation (you are here!)
â”œâ”€â”€ public/                    # Static assets
â”‚   â”œâ”€â”€ robots.txt
â”‚   â””â”€â”€ sounds/
â”‚       â””â”€â”€ success.mp3
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ components/            # React components (organized by category)
â”‚   â”‚   â”œâ”€â”€ admin/            # Admin-specific UI
â”‚   â”‚   â”œâ”€â”€ auth/             # Login, signup, child selector
â”‚   â”‚   â”œâ”€â”€ avatar/           # Avatar customizer
â”‚   â”‚   â”œâ”€â”€ badges/           # Achievement system
â”‚   â”‚   â”œâ”€â”€ beta/             # Beta testing features
â”‚   â”‚   â”œâ”€â”€ celebration/      # Success animations
â”‚   â”‚   â”œâ”€â”€ emotional/        # Emotion check-ins
â”‚   â”‚   â”œâ”€â”€ error/            # Error boundaries
â”‚   â”‚   â”œâ”€â”€ gamification/     # Points, streaks, tokens
â”‚   â”‚   â”œâ”€â”€ layout/           # Page layouts, navigation
â”‚   â”‚   â”œâ”€â”€ learning/         # Lesson components
â”‚   â”‚   â”œâ”€â”€ monitoring/       # Health status
â”‚   â”‚   â”œâ”€â”€ notifications/    # Notification center
â”‚   â”‚   â”œâ”€â”€ onboarding/       # User tutorials
â”‚   â”‚   â”œâ”€â”€ parent/           # Parent dashboard widgets
â”‚   â”‚   â”œâ”€â”€ quests/           # Daily quest system
â”‚   â”‚   â”œâ”€â”€ social/           # Peer connections
â”‚   â”‚   â””â”€â”€ ui/               # shadcn/ui components (50+)
â”‚   â”œâ”€â”€ hooks/                # Custom React hooks
â”‚   â”‚   â”œâ”€â”€ useAuth.tsx       # Authentication
â”‚   â”‚   â”œâ”€â”€ useValidatedChild.tsx  # Secure child selection
â”‚   â”‚   â”œâ”€â”€ usePlatformLessonQuota.tsx  # Daily limits
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ integrations/         # External service clients
â”‚   â”‚   â””â”€â”€ supabase/
â”‚   â”‚       â”œâ”€â”€ client.ts     # âš ï¸ AUTO-GENERATED, DO NOT EDIT
â”‚   â”‚       â””â”€â”€ types.ts      # âš ï¸ AUTO-GENERATED, DO NOT EDIT
â”‚   â”œâ”€â”€ lib/                  # Utility libraries
â”‚   â”‚   â”œâ”€â”€ analytics.ts      # Event tracking
â”‚   â”‚   â”œâ”€â”€ auditLogger.ts    # Security logging
â”‚   â”‚   â”œâ”€â”€ badgeChecker.ts   # Achievement logic
â”‚   â”‚   â”œâ”€â”€ emotionEncryption.ts  # E2E encryption
â”‚   â”‚   â”œâ”€â”€ errorHandler.ts   # Global error handling
â”‚   â”‚   â”œâ”€â”€ inputSanitization.ts  # XSS prevention
â”‚   â”‚   â”œâ”€â”€ performance.ts    # Core Web Vitals
â”‚   â”‚   â”œâ”€â”€ rateLimiter.ts    # Rate limiting
â”‚   â”‚   â”œâ”€â”€ validateChild.ts  # Ownership verification
â”‚   â”‚   â””â”€â”€ utils.ts          # Common utilities
â”‚   â”œâ”€â”€ pages/                # Route components (38 pages)
â”‚   â”‚   â”œâ”€â”€ Landing.tsx       # Public homepage
â”‚   â”‚   â”œâ”€â”€ Login.tsx         # Authentication
â”‚   â”‚   â”œâ”€â”€ ParentDashboard.tsx  # Parent home
â”‚   â”‚   â”œâ”€â”€ ChildDashboard.tsx   # Child home
â”‚   â”‚   â”œâ”€â”€ AdminDashboard.tsx   # Admin home
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ App.tsx               # Root component with routes
â”‚   â”œâ”€â”€ main.tsx              # React entry point
â”‚   â””â”€â”€ index.css             # Global styles + design tokens
â”œâ”€â”€ supabase/
â”‚   â”œâ”€â”€ config.toml           # âš ï¸ AUTO-MANAGED, DO NOT EDIT
â”‚   â”œâ”€â”€ functions/            # Edge functions (Deno)
â”‚   â”‚   â”œâ”€â”€ ai-insights/
â”‚   â”‚   â”œâ”€â”€ generate-custom-lesson/
â”‚   â”‚   â”œâ”€â”€ verify-recaptcha/
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ migrations/           # Database migrations (READ-ONLY)
â”œâ”€â”€ .env                      # âš ï¸ AUTO-GENERATED, DO NOT EDIT
â”œâ”€â”€ package.json              # âš ï¸ READ-ONLY (use tools, not manual edits)
â”œâ”€â”€ tailwind.config.ts        # Tailwind configuration
â”œâ”€â”€ vite.config.ts            # Vite bundler config
â””â”€â”€ README.md                 # Quick start guide
```

---

## Critical Files (DO NOT EDIT)

These files are auto-generated and managed by Lovable Cloud:

**âŒ Never Edit These Files:**
- `src/integrations/supabase/client.ts` - Supabase client (regenerates on DB changes)
- `src/integrations/supabase/types.ts` - TypeScript types from database schema
- `.env` - Environment variables (auto-updated)
- `supabase/config.toml` - Supabase configuration
- `package.json` - Dependencies (use tools, not manual edits)
- `supabase/migrations/*` - Database migrations (read-only)

**Why?** These files are synchronized with the Lovable Cloud backend. Manual edits will be overwritten on next deployment.

---

## Where to Add Features

### New Page

**1. Create page component:**
```bash
# Create file
touch src/pages/MyNewPage.tsx
```

**2. Add route in App.tsx:**
```typescript
import MyNewPage from './pages/MyNewPage';

// Inside <Routes>
<Route path="/my-new-page" element={<MyNewPage />} />
```

**3. Add navigation link:**
```typescript
// In Navigation.tsx or TopBar.tsx
<Link to="/my-new-page">My New Page</Link>
```

---

### New Component

**1. Choose category folder:**
```bash
# Example: Creating a new learning component
touch src/components/learning/MyComponent.tsx
```

**2. Follow component template:**
```typescript
interface MyComponentProps {
  childId: string;
  lessonId: string;
}

export const MyComponent = ({ childId, lessonId }: MyComponentProps) => {
  // Component logic
  return (
    <div className="p-4 bg-background">
      {/* Component UI */}
    </div>
  );
};
```

**3. Use shadcn/ui components:**
```typescript
import { Button } from '@/components/ui/button';
import { Card } from '@/components/ui/card';
```

---

### New Utility Function

**1. Create in lib/ folder:**
```bash
touch src/lib/myUtil.ts
```

**2. Export functions:**
```typescript
/**
 * Calculate student engagement score
 * @param views - Number of lesson views
 * @param completions - Number of completions
 * @returns Engagement percentage (0-100)
 */
export const calculateEngagement = (views: number, completions: number): number => {
  if (views === 0) return 0;
  return Math.round((completions / views) * 100);
};
```

**3. Import where needed:**
```typescript
import { calculateEngagement } from '@/lib/myUtil';
```

---

### New Hook

**1. Create hook file:**
```bash
touch src/hooks/useMyHook.tsx
```

**2. Follow React Hooks rules:**
```typescript
import { useState, useEffect } from 'react';
import { supabase } from '@/integrations/supabase/client';

export const useMyHook = (childId: string) => {
  const [data, setData] = useState<any>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<Error | null>(null);

  useEffect(() => {
    const fetchData = async () => {
      try {
        const { data, error } = await supabase
          .from('table_name')
          .select('*')
          .eq('child_id', childId);

        if (error) throw error;
        setData(data);
      } catch (err) {
        setError(err as Error);
      } finally {
        setLoading(false);
      }
    };

    fetchData();
  }, [childId]);

  return { data, loading, error };
};
```

---

### New Edge Function

**1. Create function folder:**
```bash
mkdir -p supabase/functions/my-function
touch supabase/functions/my-function/index.ts
```

**2. Implement function:**
```typescript
import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
};

serve(async (req) => {
  // Handle CORS
  if (req.method === 'OPTIONS') {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    // Verify authentication
    const authHeader = req.headers.get('Authorization');
    if (!authHeader) {
      return new Response(JSON.stringify({ error: 'Unauthorized' }), {
        status: 401,
        headers: { ...corsHeaders, 'Content-Type': 'application/json' }
      });
    }

    // Initialize Supabase client
    const supabase = createClient(
      Deno.env.get('SUPABASE_URL')!,
      Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!
    );

    // Validate user
    const token = authHeader.replace('Bearer ', '');
    const { data: { user }, error: authError } = await supabase.auth.getUser(token);
    if (authError || !user) {
      return new Response(JSON.stringify({ error: 'Invalid authentication' }), {
        status: 401,
        headers: { ...corsHeaders, 'Content-Type': 'application/json' }
      });
    }

    // Parse request body
    const { param1, param2 } = await req.json();

    // Your business logic here
    const result = { success: true, data: 'Hello World' };

    return new Response(JSON.stringify(result), {
      headers: { ...corsHeaders, 'Content-Type': 'application/json' }
    });
  } catch (error) {
    return new Response(JSON.stringify({ error: error.message }), {
      status: 500,
      headers: { ...corsHeaders, 'Content-Type': 'application/json' }
    });
  }
});
```

**3. Deploy automatically:**
- Edge functions deploy automatically on git push
- No manual deployment needed
- Check logs in Lovable Cloud â†’ Backend â†’ Functions

---

### Database Change

**âš ï¸ NEVER EDIT DATABASE MANUALLY. Use Lovable's migration tool.**

**1. Use Lovable Chat:**
```
"Create a new table called 'student_notes' with columns: id, child_id, lesson_id, note_text, created_at"
```

**2. Lovable generates migration SQL:**
```sql
CREATE TABLE public.student_notes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  child_id UUID REFERENCES public.children(id) ON DELETE CASCADE,
  lesson_id UUID REFERENCES public.lessons(id) ON DELETE CASCADE,
  note_text TEXT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Enable RLS
ALTER TABLE public.student_notes ENABLE ROW LEVEL SECURITY;

-- Create policy (parents can access their children's notes)
CREATE POLICY parent_access ON public.student_notes
FOR ALL
USING (
  child_id IN (
    SELECT id FROM public.children WHERE parent_id = auth.uid()
  )
);
```

**3. Approve and run migration**

**4. Types auto-regenerate:**
- `src/integrations/supabase/types.ts` updates automatically
- Use new types: `Database['public']['Tables']['student_notes']['Row']`

---

## Development Workflow

### Daily Development Loop

**Morning:**
1. Pull latest changes: `git pull origin main`
2. Check for migration changes (types may regenerate)
3. Start dev server: `npm run dev`

**During Development:**
1. Make changes
2. Hot reload updates automatically
3. Check browser console for errors
4. Test with different accounts (parent, child, admin)

**Before Commit:**
1. No TypeScript errors: `npm run type-check`
2. No console errors in browser
3. Test on mobile viewport (375px width)
4. Verify RLS policies work (test with different users)

**Commit:**
```bash
git add .
git commit -m "feat: Add student notes feature"
git push origin main
```

**After Push:**
- Auto-deployment triggers
- Edge functions deploy
- Frontend builds and deploys
- Check Lovable Cloud for deployment status

---

## Testing Checklist

Before committing any code, verify:

### Functionality
- [ ] Feature works as expected
- [ ] No console errors
- [ ] No network errors (check DevTools)
- [ ] Loading states display correctly
- [ ] Error messages are user-friendly

### Security
- [ ] RLS policies prevent unauthorized access
- [ ] User input is sanitized
- [ ] Child ownership validated server-side (never trust client)
- [ ] Rate limits work correctly
- [ ] No sensitive data exposed in console logs

### Performance
- [ ] No unnecessary re-renders
- [ ] Database queries optimized (use .select() with specific columns)
- [ ] Images lazy loaded
- [ ] Large components code-split

### Responsive Design
- [ ] Works on mobile (375px width)
- [ ] Works on tablet (768px width)
- [ ] Works on desktop (1920px width)
- [ ] Touch targets â‰¥44px (mobile)

### Accessibility
- [ ] Screen reader tested (if applicable)
- [ ] Keyboard navigation works
- [ ] Focus indicators visible
- [ ] Color contrast meets WCAG AA

---

## Common Pitfalls for New Developers

### Pitfall 1: Bypassing Child Validation

âŒ **WRONG (Security Vulnerability):**
```typescript
const childId = localStorage.getItem('selectedChildId');
// Use childId directly without validation
const { data } = await supabase.from('user_progress').select('*').eq('child_id', childId);
```

**Problem:** localStorage can be spoofed. Attacker could set any childId and access other children's data.

âœ… **CORRECT (Server-Side Validation):**
```typescript
const { childId } = useValidatedChild(); // Server-side validation via RLS

if (!childId) {
  return <div>No child selected</div>;
}

// Now safe to use childId
const { data } = await supabase.from('user_progress').select('*').eq('child_id', childId);
```

**Why it works:** `useValidatedChild()` queries the database with RLS policy enforcement. Even if localStorage is spoofed, the query will fail.

---

### Pitfall 2: Using .single() When Data Might Not Exist

âŒ **WRONG (Throws Error):**
```typescript
const { data, error } = await supabase
  .from('lessons')
  .select('*')
  .eq('id', lessonId)
  .single();

// If lesson doesn't exist, error is thrown
if (error) {
  // Error handling
}
```

**Problem:** `.single()` throws error if no row found. Causes unnecessary error states.

âœ… **CORRECT (Returns null):**
```typescript
const { data, error } = await supabase
  .from('lessons')
  .select('*')
  .eq('id', lessonId)
  .maybeSingle();

// If lesson doesn't exist, data is null (no error)
if (!data) {
  return <div>Lesson not found</div>;
}
```

---

### Pitfall 3: Forgetting CORS Headers in Edge Functions

âŒ **WRONG (CORS Error in Browser):**
```typescript
export default serve((req) => {
  const result = { data: 'Hello' };
  return new Response(JSON.stringify(result));
});
```

**Problem:** Browser blocks request due to missing CORS headers.

âœ… **CORRECT (CORS Enabled):**
```typescript
const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
};

export default serve((req) => {
  // Handle OPTIONS (preflight)
  if (req.method === 'OPTIONS') {
    return new Response(null, { headers: corsHeaders });
  }

  const result = { data: 'Hello' };
  return new Response(JSON.stringify(result), {
    headers: { ...corsHeaders, 'Content-Type': 'application/json' }
  });
});
```

---

### Pitfall 4: Not Sanitizing User Input

âŒ **WRONG (XSS Vulnerability):**
```typescript
const userInput = "<script>alert('XSS')</script>";
const content = `<div>${userInput}</div>`;
return <div dangerouslySetInnerHTML={{ __html: content }} />;
```

**Problem:** Script executes, stealing user data.

âœ… **CORRECT (Sanitized):**
```typescript
import { sanitizeHTML } from '@/lib/inputSanitization';

const userInput = "<script>alert('XSS')</script>";
const safeContent = sanitizeHTML(userInput);
// Result: "&lt;script&gt;alert('XSS')&lt;/script&gt;"

return <div dangerouslySetInnerHTML={{ __html: safeContent }} />;
```

---

### Pitfall 5: Hardcoding URLs in Edge Functions

âŒ **WRONG (Breaks in Different Environments):**
```typescript
const url = 'https://hcsglifjqdmiykrrmncn.supabase.co/rest/v1/lessons';
const response = await fetch(url);
```

**Problem:** URL is environment-specific. Won't work in staging/dev.

âœ… **CORRECT (Uses Environment Variables):**
```typescript
const SUPABASE_URL = Deno.env.get('SUPABASE_URL');
const url = `${SUPABASE_URL}/rest/v1/lessons`;
const response = await fetch(url);
```

---

### Pitfall 6: Not Handling Loading States

âŒ **WRONG (Bad UX):**
```typescript
const { data } = useQuery({
  queryKey: ['lessons'],
  queryFn: async () => {
    const { data } = await supabase.from('lessons').select('*');
    return data;
  }
});

return <div>{data?.map(lesson => <LessonCard lesson={lesson} />)}</div>;
```

**Problem:** Shows nothing while loading. User sees blank screen.

âœ… **CORRECT (Loading State):**
```typescript
const { data, isLoading } = useQuery({
  queryKey: ['lessons'],
  queryFn: async () => {
    const { data } = await supabase.from('lessons').select('*');
    return data;
  }
});

if (isLoading) {
  return <LoadingSpinner />;
}

return <div>{data?.map(lesson => <LessonCard lesson={lesson} />)}</div>;
```

---

## Debugging Tools

### Browser Console

**Network Tab:**
- Check for failed requests (red status codes)
- 401/403 = Authentication/authorization issues
- 429 = Rate limit exceeded
- 500 = Server error (check edge function logs)

**Console Tab:**
- React errors (red text)
- Network errors (orange text)
- Custom logs (console.log)

**Application Tab:**
- localStorage inspection (check selectedChildId)
- Session storage
- Cookies (JWT tokens)

---

### Supabase Logs

**View Edge Function Logs:**
1. Open Lovable Cloud backend (click "View Backend" button)
2. Navigate to Functions section
3. Select function name
4. Click "Logs" tab
5. Filter by:
   - Time range (last hour, last day)
   - Log level (info, warn, error)
   - Search term (e.g., "error", "userId")

**View Database Logs:**
1. Backend â†’ Logs â†’ Database
2. Filter by:
   - Query type (SELECT, INSERT, UPDATE, DELETE)
   - Table name
   - Error messages

---

### Local Error Logs

**Critical Errors (Stored in localStorage):**
```javascript
// View critical errors
const errors = JSON.parse(localStorage.getItem('critical_errors') || '[]');
console.table(errors);

// Clear errors
localStorage.removeItem('critical_errors');
```

---

### RLS Policy Testing

**Impersonate User:**
```sql
-- In Supabase SQL editor
SET request.jwt.claims = '{"sub": "user-uuid-here"}';

-- Test query (should only return authorized data)
SELECT * FROM children;

-- Reset
RESET request.jwt.claims;
```

**Verify Ownership:**
```sql
-- Check if user owns child
SELECT * FROM children WHERE id = 'child-uuid' AND parent_id = auth.uid();

-- Should return 1 row if user owns child, 0 rows otherwise
```

---

## Need Help?

**Documentation:**
- Architecture: `docs/ARCHITECTURE.md`
- Database Schema: `docs/DATABASE_SCHEMA.md`
- Edge Functions: `docs/EDGE_FUNCTIONS.md`
- Security: `docs/SECURITY.md`

**Code Reference:**
- Review similar existing code for patterns
- Check `src/components/` for component examples
- Check `src/hooks/` for hook examples

**Team:**
- Ask team lead before making architectural changes
- Pair program for complex features
- Code review all security-sensitive changes

**Security:**
- Test security implications of every change
- Never trust client-side data
- Always validate ownership server-side
- Use RLS policies as primary defense

---

## Next Steps

Now that you're set up, you should:

1. âœ… Complete onboarding checklist
2. ğŸ“– Read `docs/ARCHITECTURE.md` for system overview
3. ğŸ”’ Read `docs/SECURITY.md` for security best practices
4. ğŸ—„ï¸ Read `docs/DATABASE_SCHEMA.md` for database structure
5. ğŸš€ Read `docs/EDGE_FUNCTIONS.md` for backend API reference
6. ğŸ› Pick a starter task from the backlog
7. ğŸ¤ Pair with senior developer for first PR

**Welcome to the team! ğŸ‰**
