<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <title>Inner Odyssey - The Learning Adventure</title>
    <meta name="description" content="Enhance, engage and support your child's mental prowess!">
    <meta name="author" content="Inner Odyssey" />
    
    <!-- Performance: Preconnect to critical origins -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="preconnect" href="https://hcsglifjqdmiykrrmncn.supabase.co" />
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#FF6B9D" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="Inner Odyssey" />
    <link rel="apple-touch-icon" href="/pwa-192x192.png" />
    <link rel="manifest" href="/manifest.webmanifest" />
    
    <!-- Open Graph / Social -->
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://lovable.dev/opengraph-image-p98pqg.png" />
    <meta property="og:title" content="Inner Odyssey - The Learning Adventure">
    <meta property="og:description" content="Enhance, engage and support your child's mental prowess!">

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@lovable_dev" />
    <meta name="twitter:image" content="https://lovable.dev/opengraph-image-p98pqg.png" />
    <meta name="twitter:title" content="Inner Odyssey - The Learning Adventure">
    <meta name="twitter:description" content="Enhance, engage and support your child's mental prowess!">
    
    <!-- Performance: Font display swap -->
    <style>
      @font-face {
        font-family: 'Inter';
        font-display: swap;
        src: local('Inter');
      }
    </style>
    <!-- Critical CSS for initial loading state -->
    <style>
      .app-loading {
        position: fixed;
        inset: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, hsl(220 20% 98%) 0%, hsl(260 10% 96%) 100%);
        z-index: 9999;
        transition: opacity 0.3s ease-out;
      }
      .app-loading.hide {
        opacity: 0;
        pointer-events: none;
      }
      .app-loading-spinner {
        width: 48px;
        height: 48px;
        border: 4px solid hsl(260 60% 90%);
        border-top-color: hsl(260 60% 60%);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }
      .app-loading-text {
        margin-top: 16px;
        color: hsl(220 10% 40%);
        font-family: system-ui, -apple-system, sans-serif;
        font-size: 14px;
      }
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      @media (prefers-color-scheme: dark) {
        .app-loading {
          background: linear-gradient(135deg, hsl(220 20% 10%) 0%, hsl(260 10% 12%) 100%);
        }
        .app-loading-spinner {
          border-color: hsl(260 30% 30%);
          border-top-color: hsl(260 60% 60%);
        }
        .app-loading-text {
          color: hsl(220 10% 70%);
        }
      }
    </style>
  </head>

  <body>
    <!-- Initial loading state (removed by React when ready) -->
    <div id="app-loader" class="app-loading">
      <div class="app-loading-spinner"></div>
      <p class="app-loading-text">Loading Inner Odyssey...</p>
    </div>
    
    <div id="root"></div>
    
    <!-- PWA Startup Recovery Script - Runs BEFORE React -->
    <script>
      (function() {
        var HEALTH_KEY = 'pwa_health_timestamp';
        var RECOVERY_KEY = 'pwa_recovery_attempts';
        var MAX_RECOVERY_ATTEMPTS = 3;
        var STALE_THRESHOLD = 10000; // 10 seconds
        var WHITE_SCREEN_TIMEOUT = 8000; // 8 seconds
        
        // Check if we should trigger recovery
        function shouldRecover() {
          try {
            var lastHealth = localStorage.getItem(HEALTH_KEY);
            var recoveryAttempts = parseInt(localStorage.getItem(RECOVERY_KEY) || '0');
            
            // Don't try more than MAX_RECOVERY_ATTEMPTS times
            if (recoveryAttempts >= MAX_RECOVERY_ATTEMPTS) {
              console.log('[PWA Recovery] Max attempts reached, skipping');
              localStorage.removeItem(RECOVERY_KEY);
              return false;
            }
            
            // If health timestamp exists and is stale, likely crashed
            if (lastHealth) {
              var staleTime = Date.now() - parseInt(lastHealth);
              if (staleTime > STALE_THRESHOLD) {
                console.log('[PWA Recovery] Stale health detected:', staleTime + 'ms');
                return true;
              }
            }
          } catch (e) {
            console.warn('[PWA Recovery] Check failed:', e);
          }
          return false;
        }
        
        // Emergency cache clear
        function emergencyClear() {
          try {
            console.log('[PWA Recovery] Initiating emergency clear...');
            
            // Increment recovery attempts
            var attempts = parseInt(localStorage.getItem(RECOVERY_KEY) || '0') + 1;
            localStorage.setItem(RECOVERY_KEY, attempts.toString());
            
            // Clear service workers
            if ('serviceWorker' in navigator) {
              navigator.serviceWorker.getRegistrations().then(function(regs) {
                regs.forEach(function(r) { 
                  r.unregister();
                  console.log('[PWA Recovery] Unregistered SW');
                });
              });
            }
            
            // Clear caches
            if ('caches' in window) {
              caches.keys().then(function(names) {
                names.forEach(function(name) { 
                  caches.delete(name);
                  console.log('[PWA Recovery] Cleared cache:', name);
                });
              });
            }
            
            // Force reload after a short delay
            setTimeout(function() {
              window.location.href = window.location.origin + '?recovery=' + Date.now();
            }, 500);
          } catch (e) {
            console.error('[PWA Recovery] Emergency clear failed:', e);
          }
        }
        
        // Check for white screen after timeout
        function setupWhiteScreenDetection() {
          setTimeout(function() {
            var root = document.getElementById('root');
            if (root && root.children.length === 0) {
              console.log('[PWA Recovery] White screen detected after ' + WHITE_SCREEN_TIMEOUT + 'ms');
              emergencyClear();
            }
          }, WHITE_SCREEN_TIMEOUT);
        }
        
        // Run recovery check
        if (shouldRecover()) {
          emergencyClear();
        } else {
          // Set initial health timestamp (React will update this via heartbeat)
          try {
            localStorage.setItem(HEALTH_KEY, Date.now().toString());
          } catch (e) {}
          
          // Setup white screen detection as backup
          setupWhiteScreenDetection();
        }
      })();
    </script>
    
    <script type="module" src="/src/main.tsx"></script>
    <script src="https://www.google.com/recaptcha/api.js?render=6LeIxAcTAAAAAJcZVRqyHh71UMIEGNQ_MXjiZKhI" defer></script>
  </body>
</html>